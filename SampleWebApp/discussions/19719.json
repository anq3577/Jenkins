[
  {
    "Id": "65342",
    "ThreadId": "19719",
    "Html": "<b>Happy new year !</b><br />This is an event handler that works with Club Starter Kit, Have Fun !<br />The actual released one does not.<br /><br />&lt;%@ WebHandler Language=\"C#\" Class=\"DownloadEvent\" %&gt;<br /><br />using System;<br />using System.Text;<br />using System.IO;<br />using System.Web;<br />using System.Data;<br />using System.Data.SqlClient;<br />using SubSonic;<br />using ClubStarterKit.Data;<br /><br />public class DownloadEvent : IHttpHandler<br />{<br />  const int BUFFERSIZE = 1024;<br /><br />    public bool IsReusable<br />    {<br />        get<br />        {<br />            return true;<br />        }<br />    }<br /><br />    public void ProcessRequest( HttpContext context )<br />    {<br />        HttpResponse response = context.Response;<br />        HttpRequest request = context.Request;<br />        response.BufferOutput = true;<br />        response.ContentType = \"text/calendar\";<br />        response.Cache.SetCacheability( HttpCacheability.NoCache );<br />        int eventID = Convert.ToInt32( request.QueryString<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22EventID%22%20\"> \"EventID\" </a> );<br /><br />        Uri viewurl = new Uri( context.Request.Url, \"Events_view.aspx?Eventid=\" + eventID );<br />        writeCalEntry( eventID, response.Output, viewurl.ToString() );<br /><br />        response.AppendHeader( \"Content-Disposition\", \"attachment; filename=EventCalendar\" + eventID.ToString() + \".vcs\" );<br />        response.ContentType = \"application/download\";<br />        response.End();<br />    }<br /><br />    public void writeCalEntry( int EventID, TextWriter output, string url )<br />    {<br />        Query qry = new Query( Tables.ClubEvent );<br />        qry.AddWhere( ClubEvent.Columns.Id, EventID );<br />        qry.QueryType = QueryType.Select;<br />        qry.Top = \"1\";<br /><br />        DataTable dt = new DataTable();<br />        dt.Load( qry.ExecuteReader() );<br /><br />        if ( dt.Rows.Count &gt; 0 )<br />        {<br />            DataRow dr = dt.Rows<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%200%20\"> 0 </a>;<br /><br />            System.DateTime starttime;<br />            System.DateTime endtime;<br />            string title;<br />            string description;<br />            string location;<br />            StringBuilder sb = new StringBuilder();<br />            object o;<br /><br />            starttime = ( DateTime )dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22starttime%22%20\"> \"starttime\" </a>;<br />            if ( dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22endtime%22%20\"> \"endtime\" </a> != DBNull.Value )<br />            {<br />                endtime = ( DateTime )dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22endtime%22%20\"> \"endtime\" </a>;<br />            }<br />            else<br />            {<br />                endtime = starttime;<br />            }<br /><br />            if ( dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22title%22%20\"> \"title\" </a> != DBNull.Value )<br />            {<br />                title = ( string )( dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22title%22%20\"> \"title\" </a> );<br />            }<br />            else<br />            {<br />                title = \"An untitled clubsite event\";<br />            }<br /><br />            o = dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22description%22%20\"> \"description\" </a>;<br />            if ( o != DBNull.Value &amp;&amp; ( string )o != \"\" )<br />            {<br />                sb.AppendLine( ( string )o );<br />            }<br />            sb.AppendLine();<br />            sb.Append( \"Event URL: \" );<br />            o = dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22staticURL%22%20\"> \"staticURL\" </a>;<br />            if ( o != DBNull.Value &amp;&amp; ( string )o != \"\" )<br />            {<br />                sb.AppendLine( ( string )o );<br />            }<br />            else<br />            {<br />                sb.AppendLine( url );<br />            }<br /><br />            o = dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22LocationName%22%20\"> \"LocationName\" </a>;<br />            if ( o != DBNull.Value &amp;&amp; ( string )o != \"\" )<br />            {<br />                location = ( string )o;<br />                sb.AppendLine();<br />                sb.Append( \"Event location: \" );<br />                sb.AppendLine( location );<br />            }<br />            else<br />            {<br />                location = null;<br />            }<br /><br />            o = dr<a href=\"http://www.codeplex.com/ClubStarterKit/Wiki/View.aspx?title=%20%22LocationDirections%22%20\"> \"LocationDirections\" </a>;<br />            if ( o != DBNull.Value &amp;&amp; ( string )o != \"\" )<br />            {<br />                sb.AppendLine();<br />                sb.AppendLine( \"Location description:\" );<br />                sb.AppendLine( ( string )o );<br />            }<br /><br />            UnicodeEncoding uc = new UnicodeEncoding();<br />            description = sb.ToString();<br /><br />            output.WriteLine( \"BEGIN:VCALENDAR\" );<br />            output.WriteLine( \"VERSION:2.0\" );<br />            output.WriteLine( \"PRODID:\" + url );<br />            output.WriteLine( \"METHOD:PUBLISH\" );<br />            output.WriteLine( \"BEGIN:VEVENT\" );<br />            output.WriteLine( \"UID:\" + Guid.NewGuid().ToString() );<br />            output.WriteLine( \"DTSTAMP:\" + DateTime.Now.ToUniversalTime().ToString( \"yyyyMMddTHHmmss\" ) + \"Z\" );<br />            output.WriteLine( \"CATEGORIES:APPOINTMENT;PERSONAL\" );<br />            output.WriteLine( EncodeProperty( \"DESCRIPTION;ENCODING=QUOTED-PRINTABLE:\", description ) );<br />            output.WriteLine( \"DTEND:\" + endtime.ToUniversalTime().ToString( \"yyyyMMddTHHmmss\" ) + \"Z\" );<br />            if ( !( location == null ) )<br />            {<br />                output.WriteLine( EncodeProperty( \"LOCATION;ENCODING=QUOTED-PRINTABLE:\", location ) );<br />            }<br />            output.WriteLine( \"PRIORITY:0\" );<br />            output.WriteLine( \"DTSTART:\" + starttime.ToUniversalTime().ToString( \"yyyyMMddTHHmmss\" ) + \"Z\" );<br />            output.WriteLine( \"STATUS:NEEDS ACTION\" );<br />            output.WriteLine( EncodeProperty( \"SUMMARY;ENCODING=QUOTED-PRINTABLE:\", title ) );<br />            output.WriteLine( \"URL:\" + url );<br />            output.WriteLine( \"END:VEVENT\" );<br />            output.WriteLine( \"END:VCALENDAR\" );<br />        }<br />    }<br /><br />    string EncodeProperty( string key, string value )<br />    {<br />        StringBuilder sb = new StringBuilder();<br />        sb.Append( key );<br />        sb.Append( value );<br />        sb.Replace( \";\", \"\\\\;\", key.Length, sb.Length - key.Length );<br />        sb.Replace( \"\\r\\n\", \"=0D=0A\" );<br />        int offset = 76;<br />        while ( offset &lt; sb.Length )<br />        {<br />            int pos = sb.ToString( offset - 5, 10 ).IndexOf( \"=0D=0A\" );<br />            if ( pos == -1 )<br />            {<br />                sb.Insert( offset - 5 + pos, \"=\" + \"\\r\\n\" );<br />                offset += 79 - 5 + pos;<br />            }<br />            else<br />            {<br />                sb.Insert( offset, \"=\" + \"\\r\\n\" );<br />                offset += 79;<br />            }<br />        }<br />        return sb.ToString();<br />    }<br /><br />    string EncodeProperty64( string key, string value )<br />    {<br />        StringBuilder sb = new StringBuilder();<br />        sb.Append( key );<br />        UnicodeEncoding uc = new UnicodeEncoding();<br />        sb.Append( System.Convert.ToBase64String( uc.GetBytes( value ), Base64FormattingOptions.None ) );<br /><br />        int offset = 76;<br /><br />        while ( offset &lt; sb.Length )<br />        {<br />            sb.Insert( offset, \"\\r\\n\" );<br />            offset += 78;<br />        }<br />        return sb.ToString();<br />    }<br />}<br />",
    "PostedDate": "2007-12-29T07:50:28.797-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "66184",
    "ThreadId": "19719",
    "Html": "\r\nAnyone got a VB version?<br />",
    "PostedDate": "2008-01-04T17:05:15.7-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "66288",
    "ThreadId": "19719",
    "Html": "\r\nHi halls,<br /><br />It is an event handler .ashx so it works as well in VB or in C# you don't need anything else. Remember the CLR Common Language Rutime makes all languages compatible :<br />so Download.ashx <br />But with this one when you click on the button 'Import to my personal calendar it works making a file .cvs<br /><br />Have fun<br /><a href=\"http://www.sodevlog.fr/asp.net.blog\" class=\"externalLink\">http://www.sodevlog.fr/asp.net.blog<span class=\"externalLinkIcon\" style=\"font-family:Consolas, Courier New, Courier, Monospace;\"></span></a><br />",
    "PostedDate": "2008-01-05T13:02:33.38-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]